
<!doctype html>
<html>
<head>
  <title>Relationships</title>

  <style type="text/css">
    body {
      font: 10pt sans;
    }
    #mynetwork {
      width: 1200px;
      height: 1200px;
      border: 1px solid lightgray;
    }
  </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/util.js"></script>
    <script type="text/javascript" src="static/js/vendor/vis.js"></script>
    <link href="static/css/vendor/vis.min.css" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        body {
            font: 10pt sans;
        }

        #mynetwork {
            width: 600px;
            height: 600px;
            border: 1px solid lightgray;
        }
    </style>

    <script>
        $(document).ready(function() {
            var dimensionData = {{ dimension| tojson | safe }};
            currentDimension = dimensionData['data'];
            console.log("setting current dimeion to " + currentDimension);
            $("#dimensions option[value='" + currentDimension + "']").prop('selected', true);
            searchButtonEl = $('#search-button');
            searchButtonEl.click( onSearch )

        });

        function onSearch() {
            var term = document.getElementById('search-text').value;
            var hits = new Array();
            for ( var nodeId in currentNodes ) {
                var node = currentNodes[nodeId];
                if ( node['label'].includes(term)) {
                    hits.push( node );
                }
            }
            console.log(hits);
            colorSearchHits(hits);
            draw_graph();
        }

        function colorSearchHits(nodes) {
            for (var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                node.color = 'rgb(255,168,7)';
                var connectedNodes = network.getConnectedNodes(selectedNode);
                var allConnectedNodes = [];
                if (connectedNodes) {
                    for (var i = 0; i < connectedNodes.length; i++) {
                        allConnectedNodes = allConnectedNodes.concat(network.getConnectedNodes(connectedNodes[i]))
                    }
                }
            console.log()
            }

        }

    </script>

  <script type="text/javascript">
    var network = null;
    var currentDimension = null;
    var currentNodes = null;
    var currentEdges = null;
    var currentOptions = null;


    function destroy() {
      if (network !== null) {
        network.destroy();
        network = null;
      }
    }

    function draw() {
      currentNodes = {{ nodes | tojson | safe }};
      currentEdges = {{  edges | tojson | safe }};
      currentOptions = {{  options | tojson | safe }}
      draw_graph();
    }

    function draw_graph() {

        nodes = [];
        edges = [];

        var options = currentOptions;

        console.log(options);

        for (var nodeId in currentNodes) {
            nodes.push(currentNodes[nodeId]);
        }

        for (var edgeId in currentEdges) {
            var edge = currentEdges[edgeId];
            var fromId = edge['from']['id']
            var toId = edge['to']['id']

            if (fromId == toId) {
                node = edge['from']
                label = node['label']
                label += " (" + edge['count'] + ")"
                node['label'] = label
            }
            else {
                edges.push({
                    from: fromId,
                    to: toId,
                    arrows: 'middle',
                    label: edge['count']
                });
            }
        }

        // create a network
        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        network = new vis.Network(container, data, options);
    }

  </script>
</head>

<body onload="draw();">
<div id="controls">
    <select id="dimensions" name="dimensions" class="dimensions">
        {% for d in dimensions %}
            <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
    </select>
    <input type="search" id="search-text" title="Search" style="width: 250px;border:  1px solid #ccc;font-size: 14px;"
         placeholder="type in here to search">
    <button name="search-button" id="search-button" style="width:30px;height:31px;padding:2px;">Go!</button>
</div>

<script>
$('.dimensions').on('change', function() {
    var dimensionValue = this.value;
    var url = "/get_dimension";
    $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: url,
            data: JSON.stringify({ data: { 'dimension' : dimensionValue } } ),
            success: function (data) {
                currentNodes   = data['nodes'];
                currentEdges   = data['edges'];
                currentOptions = data['options']
                draw_graph();
            },
            dataType: "json"
    });


});
</script>

<div style="width:700px; font-size:14px; text-align: justify;">
</div>


<div id="mynetwork" style="width:1200px; font-size:14px; text-align: justify;"></div>

<p id="selection"></p>
</body>
</html>
